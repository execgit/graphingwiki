#! /usr/bin/env python
# -*- coding: utf-8 -*-
"""
    @copyright: 2008 Lari Huttunen
    @license: MIT <http://www.opensource.org/licenses/mit-license.php>
"""
import os
import sys
import re
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from opencollab.meta import Meta, Metas
from opencollab.wiki import CLIWiki, WikiFailure

def get_page_html(collab, page):
    content = ""
    try:
        content = collab.getPageHTML(page)
    except WikiFailure, msg:
        print "WikiFailure: ", msg
    else:
        return content

def send_content(url,page_content,recipient):
    sender = "opencollab-notifier@do.not.respond.to.me.INVALID"
    msg = MIMEMultipart()
    msg['Subject'] = "Changes at: " + url
    msg['From'] = sender
    msg['To'] = recipient
    msg.preamble = "Recent changes at: " + url
    for page in page_content:
        content = url + page + "\n\n" + MIMEText(page)
        msg.attach(content)
    s = smtplib.SMTP()
    s.connect()
    s.sendmail(sender, recipient, msg.as_string())
    s.close()

def main():
    import optparse

    parser = optparse.OptionParser()
    parser.add_option("-c", "--config",
                      dest="config",
                      default=None,
                      metavar="CONFIG",
                      help=("Read configurable variables from CONFIG."))
    parser.add_option("-a", "--arguments",
                      dest="meta_args",
                      default=None,
                      metavar="ARGUMENTS",
                      help=("Metatable search ARGUMENTS."))
    parser.add_option("-r", "--recipient",
                      dest="recipient",
                      default=None,
                      metavar="RECIPIENT",
                      help=("Metatable search RECIPIENT."))
    options, args = parser.parse_args()

    url = ''
    meta_args=''
    recipient=''
    page_content = {}
    if args:
        url = args[0]
    collab = CLIWiki(url, config=options.config)
    pages = Metas() 
    if(options.meta_args):
        meta_args = options.meta_args
    pages = collab.getMeta(meta_args)
    for page in pages:
        page_html = get_page_html(collab, page)
        page_content[page] = page_html
    send_content(url,page_content,recipient)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print "Script interrupted via CTRL-C."

